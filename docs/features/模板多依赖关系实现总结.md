# 模板多依赖关系实现总结

## 需求场景

支持复杂的工作流依赖关系：
- **A → B, C**: B和C并行依赖A（A完成后，B和C可以并行执行）
- **D 依赖 B, C**: D需要等待B和C都完成后才能执行（AND关系）

## 技术实现

### 1. 后端数据模型 ✅

#### 依赖存储
- **字段**: `dependencies` (JSON字符串)
- **格式**: `["step_id_1", "step_id_2", ...]`
- **解析**: 运行时解析为数组

#### DAG验证
- **算法**: Kahn拓扑排序算法
- **功能**: 检测环路，确保DAG有效性
- **位置**: `internal/service/template.go:validateDAG`

### 2. 前端组件优化 ✅

#### 依赖选择组件
- **文件**: `src/components/TemplateStepDialog.vue`
- **特性**:
  - 多选模式 (`mode="multiple"`)
  - 搜索功能 (`show-search`)
  - 标签限制 (`max-tag-count="3"`)
  - 依赖关系说明（动态生成）

#### 用户体验改进
```javascript
// 依赖关系说明计算属性
const dependencyDescription = computed(() => {
  if (form.dependencies.length === 1) {
    return `${currentStepName} 将在 "${depNames[0]}" 完成后执行`
  } else {
    return `${currentStepName} 将在 "${depNames.join('", "')}" 全部完成后执行（AND关系）`
  }
})
```

### 3. 测试用例验证 ✅

#### 复杂工作流案例
```
A (step_A) - 初始步骤
├── B (step_B) - 依赖A，并行执行
├── C (step_C) - 依赖A，并行执行  
└── D (step_D) - 依赖B和C，串行执行
```

#### DAG结构验证
- **节点**: 4个步骤节点
- **边**: 4条依赖边
  - A → B
  - A → C  
  - B → D
  - C → D

#### 执行顺序
1. **第1层**: A 执行
2. **第2层**: B, C 并行执行（等待A完成）
3. **第3层**: D 执行（等待B和C都完成）

## 关键特性

### 1. 多依赖支持 ✅
- 支持一个步骤依赖多个前置步骤
- 所有依赖步骤必须完成后才执行（AND关系）

### 2. 并行执行 ✅  
- 支持同级步骤并行执行
- 通过`run_mode: "parallel"`标识

### 3. 依赖验证 ✅
- 前端：实时依赖关系说明
- 后端：DAG环路检测
- 确保工作流的有效性

### 4. 可视化展示 ✅
- DAG图形化展示
- 节点类型区分
- 依赖关系连线

## 使用方式

### 1. 创建模板步骤
```json
{
  "step_id": "step_d_id",
  "dependencies": ["step_b_id", "step_c_id"],
  "run_mode": "serial",
  "on_failure": "abort",
  "order": 3
}
```

### 2. 前端操作
1. 在模板创建/编辑中点击"添加步骤"
2. 选择步骤ID
3. 在"依赖步骤"中多选需要的前置步骤
4. 查看依赖关系说明确认逻辑
5. 保存配置

### 3. 依赖关系说明示例
- **单依赖**: "step_B 将在 "step_A" 完成后执行"
- **多依赖**: "step_D 将在 "step_B", "step_C" 全部完成后执行（AND关系）"

## 执行引擎支持

### 1. 并行调度
- 相同层级的并行步骤可以同时执行
- 提高工作流执行效率

### 2. 依赖等待
- 步骤执行前检查所有依赖是否完成
- 支持复杂的多依赖等待逻辑

### 3. 失败处理
- 支持多种失败策略
- 依赖失败时的级联处理

## 数据示例

### 模板定义
```json
{
  "name": "complex_workflow_template",
  "steps": [
    {"step_id": "A", "dependencies": [], "order": 1},
    {"step_id": "B", "dependencies": ["A"], "order": 2},
    {"step_id": "C", "dependencies": ["A"], "order": 2}, 
    {"step_id": "D", "dependencies": ["B", "C"], "order": 3}
  ]
}
```

### DAG输出
```json
{
  "nodes": [...],
  "edges": [
    {"source": "A", "target": "B"},
    {"source": "A", "target": "C"},
    {"source": "B", "target": "D"},
    {"source": "C", "target": "D"}
  ]
}
```

## 优势特点

1. **灵活性**: 支持任意复杂的依赖关系
2. **可视化**: 清晰的DAG图形展示
3. **验证性**: 完整的环路检测和验证
4. **用户友好**: 直观的依赖关系说明
5. **高效性**: 支持并行执行优化

## 技术栈

- **后端**: Go + Gin + GORM + 拓扑排序算法
- **前端**: Vue 3 + Ant Design Vue + 多选组件
- **数据存储**: JSON字符串存储依赖数组
- **可视化**: SVG + 自动布局算法